\doxysection{thread\+\_\+pool.\+hpp}
\hypertarget{thread__pool_8hpp_source}{}\label{thread__pool_8hpp_source}\index{include/webcraft/async/thread\_pool.hpp@{include/webcraft/async/thread\_pool.hpp}}
\mbox{\hyperlink{thread__pool_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Copyright\ (c)\ Aditya\ Rao}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ Licenced\ under\ MIT\ license.\ See\ LICENSE.txt\ for\ details.}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <chrono>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <condition\_variable>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <stop\_token>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <unordered\_map>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <queue>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <set>}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ <future>}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{using\ namespace\ }std::chrono\_literals;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacewebcraft_1_1async}{webcraft::async}}}
\DoxyCodeLine{00024\ \{}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{keyword}{class\ }\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__shutdown__error}{thread\_pool\_shutdown\_error}}\ :\ \textcolor{keyword}{public}\ std::runtime\_error}
\DoxyCodeLine{00027\ \ \ \ \ \{}
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__shutdown__error_a1893065b1aea47dc99629060ee5e3739}{thread\_pool\_shutdown\_error}}()\ :\ std::runtime\_error(\textcolor{stringliteral}{"{}Thread\ pool\ is\ shutting\ down"{}})\ \{\}}
\DoxyCodeLine{00030\ \ \ \ \ \};}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keyword}{class\ }thread\_pool;}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keyword}{class\ }\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker}{thread\_pool\_worker}}}
\DoxyCodeLine{00035\ \ \ \ \ \{}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ std::jthread\ thr;}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool}{thread\_pool}}\ *pool;}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker}{thread\_pool\_worker}}(\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool}{thread\_pool}}\ *pool);}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aba91a894b8d88dfa23fb31ed6d015f5d}{\string~thread\_pool\_worker}}()}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aa8f928e40cab2f2efa3f1700abf65987}{request\_stop}}();}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aa8f928e40cab2f2efa3f1700abf65987}{request\_stop}}()}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ thr.request\_stop();}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aa79ab990a0e541398ee6695130d565f4}{run\_loop}}(std::stop\_token\ token);}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ std::thread::id\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_a4b98d1d2e21e8ea6971cbc3d440782c7}{get\_id}}()}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ thr.get\_id();}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00059\ \ \ \ \ \};}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keyword}{class\ }\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool}{thread\_pool}}}
\DoxyCodeLine{00062\ \ \ \ \ \{}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ min\_threads,\ max\_threads;}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::chrono::milliseconds\ idle\_timeout;}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ std::unordered\_map<std::thread::id,\ std::unique\_ptr<thread\_pool\_worker>>\ workers;}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ std::vector<std::unique\_ptr<thread\_pool\_worker>>\ workers\_to\_remove;}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ std::queue<std::function<void()>>\ tasks;}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keyword}{mutable}\ std::mutex\ mutex;}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ std::condition\_variable\ cv;}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ std::atomic<int>\ available\_workers\{0\};}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ std::atomic<bool>\ shutdown\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker}{thread\_pool\_worker}};}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_aea82fd2172489074165235730e332570}{thread\_pool}}(\textcolor{keywordtype}{size\_t}\ min\_threads\ =\ 0,\ \textcolor{keywordtype}{size\_t}\ max\_threads\ =\ std::thread::hardware\_concurrency(),\ std::chrono::milliseconds\ idle\_timeout\ =\ 10'000ms)\ :\ min\_threads(min\_threads),\ max\_threads(max\_threads),\ idle\_timeout(idle\_timeout)}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ min\_threads;\ i++)}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ worker\ =\ std::make\_unique<thread\_pool\_worker>(\textcolor{keyword}{this});}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ workers[worker-\/>get\_id()]\ =\ std::move(worker);}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_ad15055849d1a8a0836b4fded9295abcc}{\string~thread\_pool}}()}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_aae466a2741b3efa9f5f17f7f19a1ba55}{try\_shutdown}}();}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_aae466a2741b3efa9f5f17f7f19a1ba55}{try\_shutdown}}()}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ expected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (shutdown.compare\_exchange\_strong(expected,\ \textcolor{keyword}{true},\ std::memory\_order\_acq\_rel))}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Request\ stop\ for\ all\ workers}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_lock<std::mutex>\ lock(mutex);}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ \&it\ :\ workers)}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ it.second-\/>request\_stop();}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cv.notify\_all();}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ all\ workers\ to\ finish\ and\ clean\ up}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ workers.clear();}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ F,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a1872beb7bf2cef37b4424654c1ac68fd}{submit}}(F\ \&\&f,\ Args\ \&\&...args)\ -\/>\ std::future<\textcolor{keyword}{typename}\ std::invoke\_result\_t<F,\ Args...>>}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }return\_type\ =\ \textcolor{keyword}{typename}\ std::invoke\_result\_t<F,\ Args...>;}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}}\ =\ std::make\_shared<std::packaged\_task<return\_type()>>(}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::bind(std::forward<F>(f),\ std::forward<Args>(args)...));}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ std::future<return\_type>\ result\ =\ \mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}}-\/>get\_future();}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (shutdown.load())}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Return\ a\ future\ with\ an\ exception\ if\ shutting\ down}}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::promise<return\_type>\ promise;}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__shutdown__error}{thread\_pool\_shutdown\_error}}();}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{catch}\ (...)}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ promise.set\_exception(std::current\_exception());}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ promise.get\_future();}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_lock<std::mutex>\ lock(mutex);}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clean\ up\ workers\ marked\ for\ removal}}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cleanup\_workers();}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ we\ need\ to\ create\ a\ new\ worker}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (available\_workers.load()\ ==\ 0\ \&\&\ workers.size()\ <\ max\_threads)}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ worker\ =\ std::make\_unique<thread\_pool\_worker>(\textcolor{keyword}{this});}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ worker\_id\ =\ worker-\/>get\_id();}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ workers[worker\_id]\ =\ std::move(worker);}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tasks.push([\mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}}]()}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ (*task)();\ \});}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ cv.notify\_one();}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a8f16d178a02a392feb5767055a714491}{get\_min\_threads}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00161\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ min\_threads;}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_aafa668fb25c2e9e62a21679f15a2b495}{get\_max\_threads}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00166\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ max\_threads;}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::chrono::milliseconds\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a1626664bfda9cd7089c83c94e4ffbe46}{get\_idle\_timeout}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00171\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ idle\_timeout;}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a3bd09c30c9fa0089d416f04f0ad4e0b7}{get\_workers\_size}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00176\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_lock<std::mutex>\ lock(mutex);}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ workers.size();}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a1f4275112f77e63b926daa05aad0c047}{get\_available\_workers}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00182\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ available\_workers.load();}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ cleanup\_workers()}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ workers\_to\_remove.clear();}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00191\ \ \ \ \ \};}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_ab55fb0290ed65ebfceb95ae053381deb}{thread\_pool\_worker::thread\_pool\_worker}}(\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool}{thread\_pool}}\ *pool)\ :\ pool(pool)}
\DoxyCodeLine{00194\ \ \ \ \ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ pool-\/>available\_workers.fetch\_add(1);}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ thr\ =\ std::jthread([\textcolor{keyword}{this}](std::stop\_token\ token)}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aa79ab990a0e541398ee6695130d565f4}{run\_loop}}(token);\ \});}
\DoxyCodeLine{00198\ \ \ \ \ \}}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_aa79ab990a0e541398ee6695130d565f4}{thread\_pool\_worker::run\_loop}}(std::stop\_token\ token)}
\DoxyCodeLine{00201\ \ \ \ \ \{}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!token.stop\_requested()\ \&\&\ !pool-\/>shutdown.load())}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ std::function<void()>\ \mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}};}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ has\_task\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_lock<std::mutex>\ lock(pool-\/>mutex);}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ status\ =\ pool-\/>cv.wait\_for(lock,\ pool-\/>\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a1626664bfda9cd7089c83c94e4ffbe46}{get\_idle\_timeout}}(),\ [\textcolor{keyword}{this},\ \&token]()}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ return\ !pool-\/>tasks.empty()\ ||\ token.stop\_requested()\ ||\ pool-\/>shutdown.load();\ \});}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!status\ \&\&\ pool-\/>tasks.empty()\ \&\&\ !pool-\/>shutdown.load())}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Timeout\ occurred\ and\ no\ tasks\ available}}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pool-\/>workers.size()\ >\ pool-\/>\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool_a8f16d178a02a392feb5767055a714491}{get\_min\_threads}}())}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Mark\ this\ worker\ for\ removal\ instead\ of\ removing\ immediately}}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ worker\ =\ std::move(pool-\/>workers.at(\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_a4b98d1d2e21e8ea6971cbc3d440782c7}{get\_id}}()));}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>workers.erase(\mbox{\hyperlink{classwebcraft_1_1async_1_1thread__pool__worker_a4b98d1d2e21e8ea6971cbc3d440782c7}{get\_id}}());}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>workers\_to\_remove.push\_back(std::move(worker));}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>available\_workers.fetch\_sub(1);}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (token.stop\_requested()\ ||\ pool-\/>shutdown.load())}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>available\_workers.fetch\_sub(1);}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!pool-\/>tasks.empty())}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}}\ =\ std::move(pool-\/>tasks.front());}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>tasks.pop();}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ has\_task\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>available\_workers.fetch\_sub(1);}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Execute\ task\ with\ exception\ handling}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_task)}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classwebcraft_1_1async_1_1task}{task}}();}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{catch}\ (...)}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Log\ exception\ or\ handle\ appropriately}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ now,\ we'll\ just\ continue\ to\ prevent\ thread\ termination}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ pool-\/>available\_workers.fetch\_add(1);}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00257\ \ \ \ \ \}}
\DoxyCodeLine{00258\ \}}

\end{DoxyCode}
